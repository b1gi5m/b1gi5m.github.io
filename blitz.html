<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>BLITZ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Noto+Sans+KR:wght@400;700;900&display=swap');
:root {
  --felt:#2d5a3d; --felt-d:#1a3d28; --felt-l:#3d7050;
  --ink:#1a1410; --gold:#f9c74f; --accent:#c0392b;
  --card:#fdf9f0; --card-b:#cfc0a0;
  /* JS will override these */
  --cw:140px; --ch:196px; --dw:100px; --dh:140px; --ns:16px;
}
*{box-sizing:border-box;margin:0;padding:0;
  -webkit-tap-highlight-color:transparent;
  user-select:none;-webkit-user-select:none;}
body{background:var(--felt);font-family:'Noto Sans KR',sans-serif;
  width:100dvw;height:100dvh;overflow:hidden;}
.screen{display:none;width:100%;height:100%;position:absolute;top:0;left:0;}
.screen.active{display:flex;}

/* ── SETUP ── */
#setup{flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at center,var(--felt-l),var(--felt-d));
  padding:28px 24px;gap:18px;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:clamp(80px,20vw,120px);
  color:white;letter-spacing:10px;line-height:1;text-shadow:0 4px 32px rgba(0,0,0,.6);}
.logo em{color:var(--gold);font-style:normal;}
.setup-box{background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.12);
  border-radius:24px;padding:22px 20px;width:100%;max-width:440px;
  display:flex;flex-direction:column;gap:18px;}
.slabel{font-size:11px;font-weight:700;letter-spacing:3px;
  color:rgba(255,255,255,.4);text-transform:uppercase;margin-bottom:8px;}
.count-row{display:flex;gap:10px;}
.count-btn{flex:1;padding:14px 8px;border:2px solid rgba(255,255,255,.15);
  border-radius:14px;background:rgba(255,255,255,.07);
  font-family:'Bebas Neue',sans-serif;font-size:28px;
  color:rgba(255,255,255,.4);cursor:pointer;transition:all .2s;}
.count-btn.active{border-color:var(--gold);color:var(--gold);background:rgba(249,199,79,.1);}
.name-inputs{display:flex;flex-direction:column;gap:8px;}
.name-input{width:100%;padding:12px 16px;border:2px solid rgba(255,255,255,.12);
  border-radius:12px;background:rgba(255,255,255,.07);font-size:16px;
  color:white;outline:none;}
.name-input::placeholder{color:rgba(255,255,255,.25);}
.name-input:focus{border-color:rgba(255,255,255,.4);}
.cc-row{display:flex;align-items:center;justify-content:center;gap:14px;}
.cc-btn{width:44px;height:44px;border-radius:12px;border:none;
  background:rgba(255,255,255,.1);color:white;font-size:22px;
  cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.cc-btn:active{background:rgba(255,255,255,.2);}
.cc-val{font-family:'Bebas Neue',sans-serif;font-size:36px;color:var(--gold);
  min-width:70px;text-align:center;}
.cc-desc{font-size:12px;color:rgba(255,255,255,.35);text-align:center;}
.inf-toggle{display:flex;align-items:center;justify-content:center;gap:10px;margin-top:6px;}
.inf-toggle-lbl{font-size:13px;color:rgba(255,255,255,.5);}
.toggle-switch{position:relative;width:46px;height:26px;cursor:pointer;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-track{position:absolute;inset:0;border-radius:13px;
  background:rgba(255,255,255,.15);transition:background .2s;}
.toggle-thumb{position:absolute;width:20px;height:20px;border-radius:50%;
  background:white;top:3px;left:3px;transition:transform .2s;}
.toggle-switch input:checked + .toggle-track{background:var(--gold);}
.toggle-switch input:checked + .toggle-track + .toggle-thumb,
.toggle-switch input:checked ~ .toggle-thumb{transform:translateX(20px);}
/* Simpler toggle using label trick */
.tog{display:flex;align-items:center;gap:10px;cursor:pointer;}
.tog-pill{width:48px;height:28px;border-radius:14px;background:rgba(255,255,255,.15);
  position:relative;transition:background .2s;flex-shrink:0;}
.tog-pill::after{content:'';position:absolute;width:22px;height:22px;border-radius:50%;
  background:white;top:3px;left:3px;transition:transform .22s;}
.tog.on .tog-pill{background:var(--gold);}
.tog.on .tog-pill::after{transform:translateX(20px);}
.tog-lbl{font-size:13px;color:rgba(255,255,255,.5);}
.start-btn{width:100%;max-width:440px;padding:18px;border:none;border-radius:16px;
  background:var(--gold);color:var(--ink);
  font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;
  cursor:pointer;box-shadow:0 6px 24px rgba(0,0,0,.35);transition:transform .15s;}
.start-btn:active{transform:scale(.97);}

/* ── GAME TABLE ── */
#game{position:relative;
  background:radial-gradient(ellipse at center,var(--felt-l) 0%,var(--felt) 50%,var(--felt-d) 100%);}
#game::before{content:'';position:absolute;inset:0;pointer-events:none;
  background-image:
    repeating-linear-gradient(0deg,transparent,transparent 4px,rgba(0,0,0,.018) 4px,rgba(0,0,0,.018) 8px),
    repeating-linear-gradient(90deg,transparent,transparent 4px,rgba(0,0,0,.018) 4px,rgba(0,0,0,.018) 8px);}

/* CENTER */
.center-area{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  display:flex;align-items:center;justify-content:center;gap:14px;z-index:10;}

.deck-card{width:var(--dw);height:var(--dh);background:var(--ink);
  border:3px solid rgba(255,255,255,.12);border-radius:14px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;flex-shrink:0;
  box-shadow:4px 4px 0 #0a0806,8px 8px 0 rgba(0,0,0,.28);
  transition:transform .12s,box-shadow .12s;position:relative;}
.deck-card:active{transform:translate(3px,3px);box-shadow:1px 1px 0 #0a0806;}
.deck-card.empty{opacity:.25;pointer-events:none;}
.deck-num{font-family:'Bebas Neue',sans-serif;
  font-size:calc(var(--dw) * 0.5);color:white;line-height:1;}
.deck-lbl{font-size:calc(var(--dw) * 0.13);letter-spacing:2px;
  color:rgba(255,255,255,.3);margin-top:4px;}

.wild-card{width:var(--dw);height:var(--dh);
  background:var(--ink);
  border:3px solid rgba(255,255,255,.14);
  border-radius:14px;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:8px;flex-shrink:0;
  box-shadow:2px 2px 10px rgba(0,0,0,.5);}
.wild-syms{display:flex;gap:8px;font-size:calc(var(--dw) * 0.4);}
.wild-lbl{font-size:calc(var(--dw) * 0.12);letter-spacing:2px;
  color:rgba(255,255,255,.35);text-transform:uppercase;}
.wild-empty{width:var(--dw);height:var(--dh);border-radius:14px;
  border:2px dashed rgba(255,255,255,.1);flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-family:'Bebas Neue',sans-serif;font-size:16px;
  letter-spacing:2px;color:rgba(255,255,255,.1);}

/* PLAYER AREAS */
.player-area{position:absolute;display:flex;flex-direction:column;
  align-items:center;gap:10px;z-index:5;padding:8px;}
.player-area[data-pos="bottom"]      {bottom:0;left:50%;transform:translateX(-50%);}
.player-area[data-pos="top"]         {top:0;left:50%;transform:translateX(-50%) rotate(180deg);}
.player-area[data-pos="left"]        {left:0;top:50%;transform:translateY(-50%) rotate(90deg);}
.player-area[data-pos="right"]       {right:0;top:50%;transform:translateY(-50%) rotate(-90deg);}
.player-area[data-pos="bottom-left"] {bottom:0;left:0;}
.player-area[data-pos="bottom-right"]{bottom:0;right:0;}
.player-area[data-pos="top-left"]    {top:0;left:0;transform:rotate(180deg);}
.player-area[data-pos="top-right"]   {top:0;right:0;transform:rotate(180deg);}

.player-row{display:flex;gap:12px;align-items:flex-end;}

/* PLAY PILE WRAPPER — for stack shadow layers */
.play-pile-wrap{position:relative;width:var(--cw);height:var(--ch);flex-shrink:0;
  overflow:visible;}
.stack-shadow{position:absolute;border-radius:16px;
  background:#2a2420;border:1px solid rgba(255,255,255,.15);pointer-events:none;}

/* PLAY PILE CARD — dark back design (face-down pile), top card face-up */
.play-pile-card{
  position:absolute;inset:0;
  border-radius:16px;
  background:var(--ink);
  border:3px solid rgba(255,255,255,.12);
  display:flex;flex-direction:column;
  align-items:center;justify-content:space-between;
  box-shadow:0 6px 24px rgba(0,0,0,.6);
  overflow:hidden;padding:10px 8px;z-index:10;
}
.play-pile-card.empty{
  background:rgba(255,255,255,.04);
  border:2px dashed rgba(255,255,255,.2);
  box-shadow:none;justify-content:center;
}
.play-pile-card.match{border-color:var(--accent);
  animation:matchglow 1s infinite alternate;}
@keyframes matchglow{
  from{box-shadow:0 0 0 5px rgba(192,57,43,.55),0 6px 24px rgba(0,0,0,.6);}
  to  {box-shadow:0 0 0 12px rgba(192,57,43,.06),0 6px 24px rgba(0,0,0,.6);}
}

/* Card content: topic top + big symbol + topic bottom
   Layout from card top to bottom:
   - .topic-far  : text at physical top of card, rotated 180deg → reads correctly for player on FAR side
   - .sym-center : big symbol in middle
   - .topic-near : text at physical bottom, no rotation → reads correctly for player on NEAR side (card owner)
   For bottom player (no area rotation): near = bottom of card = their side ✓
   For top player (area rotated 180deg): entire area is flipped, so bottom of card faces them ✓
*/
.topic-far{
  width:100%;text-align:center;font-weight:900;
  font-size:calc(var(--cw) * 0.165);
  color:rgba(255,255,255,.85);line-height:1.2;
  transform:rotate(180deg);
}
.sym-center{
  font-size:calc(var(--cw) * 0.65);
  line-height:1;flex-shrink:0;
}
.topic-near{
  width:100%;text-align:center;font-weight:900;
  font-size:calc(var(--cw) * 0.165);
  color:rgba(255,255,255,.85);line-height:1.2;
}

/* SCORE PILE WRAPPER */
.score-pile-wrap{position:relative;width:calc(var(--cw) * 0.72);height:var(--ch);flex-shrink:0;
  overflow:visible;}
.score-shadow{position:absolute;border-radius:14px;
  background:#2a2420;border:1px solid rgba(255,255,255,.15);pointer-events:none;}
.score-pile-btn{position:absolute;inset:0;border-radius:14px;
  background:rgba(255,255,255,.08);border:2px dashed rgba(255,255,255,.22);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:5px;cursor:pointer;z-index:10;
  transition:border-color .2s,background .2s,box-shadow .2s;}
.score-pile-btn.claimable{border-color:var(--gold);background:rgba(249,199,79,.12);
  animation:scoreglow 1s infinite alternate;}
@keyframes scoreglow{
  from{box-shadow:0 0 0 4px rgba(249,199,79,.45);}
  to  {box-shadow:0 0 0 10px rgba(249,199,79,.05);}
}
.score-num{font-family:'Bebas Neue',sans-serif;
  font-size:calc(var(--cw) * 0.38);color:white;line-height:1;}
.score-lbl{font-size:calc(var(--cw) * 0.11);letter-spacing:1px;
  color:rgba(255,255,255,.35);text-transform:uppercase;}

.player-name{font-size:var(--ns);font-weight:700;letter-spacing:2px;
  text-transform:uppercase;color:rgba(255,255,255,.5);}
.player-name.cur{color:var(--gold);}

/* Turn label */
.turn-label{position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%) translateY(80px);
  font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:3px;
  color:rgba(255,255,255,.18);pointer-events:none;z-index:4;}

/* FLYING CARD */
.flying-card{position:fixed;border-radius:14px;
  background:var(--ink);
  border:3px solid rgba(255,255,255,.12);
  display:flex;flex-direction:column;
  align-items:center;justify-content:space-between;
  padding:8px 6px;
  box-shadow:0 14px 48px rgba(0,0,0,.75);
  pointer-events:none;z-index:1000;will-change:transform,opacity;}
.flying-card.fly{transition:transform .38s cubic-bezier(.25,.46,.45,.94),opacity .38s ease;}

/* ── END ── */
#end{flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at center,var(--felt-l),var(--felt-d));padding:40px 24px;}
.end-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(60px,16vw,90px);
  letter-spacing:6px;color:white;text-align:center;}
.end-sub{font-size:12px;letter-spacing:3px;color:rgba(255,255,255,.4);
  text-align:center;margin-bottom:28px;margin-top:6px;text-transform:uppercase;}
.lb{width:100%;max-width:440px;display:flex;flex-direction:column;gap:10px;}
.lb-row{display:flex;align-items:center;gap:16px;
  background:rgba(255,255,255,.09);border-radius:18px;padding:18px 24px;}
.lb-row.first{background:rgba(249,199,79,.14);}
.lb-rank{font-family:'Bebas Neue',sans-serif;font-size:32px;
  color:rgba(255,255,255,.25);width:32px;text-align:center;}
.lb-rank.gold{color:var(--gold);}
.lb-name{flex:1;font-size:20px;font-weight:700;color:white;}
.lb-score{font-family:'Bebas Neue',sans-serif;font-size:30px;color:var(--gold);}
.end-btns{display:flex;gap:12px;margin-top:32px;width:100%;max-width:440px;}
.end-btn{flex:1;padding:18px;border-radius:14px;
  border:2px solid rgba(255,255,255,.15);background:rgba(255,255,255,.08);
  color:white;font-family:'Bebas Neue',sans-serif;font-size:22px;
  letter-spacing:3px;cursor:pointer;transition:transform .1s;}
.end-btn.primary{background:var(--gold);color:var(--ink);border-color:transparent;}
.end-btn:active{transform:scale(.97);}
.toast{position:fixed;bottom:40px;left:50%;
  transform:translateX(-50%) translateY(14px);background:rgba(0,0,0,.88);
  color:white;padding:12px 26px;border-radius:40px;font-size:15px;font-weight:600;
  opacity:0;transition:all .3s;pointer-events:none;z-index:999;white-space:nowrap;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<div id="setup" class="screen active">
  <div class="logo">BL<em>I</em>TZ</div>
  <div class="setup-box">
    <div>
      <div class="slabel">플레이어 수</div>
      <div class="count-row" id="count-row">
        <button class="count-btn active" data-n="2">2</button>
        <button class="count-btn" data-n="3">3</button>
        <button class="count-btn" data-n="4">4</button>
      </div>
    </div>
    <div>
      <div class="slabel">이름</div>
      <div class="name-inputs" id="name-inputs"></div>
    </div>
    <div>
      <div class="slabel">총 카드 수</div>
      <div class="cc-row">
        <button class="cc-btn" id="cc-dec">−</button>
        <div style="text-align:center">
          <div class="cc-val" id="cc-val">54</div>
          <div class="cc-desc">덱 A + 덱 B 합산</div>
        </div>
        <button class="cc-btn" id="cc-inc">+</button>
      </div>
      <div class="inf-toggle" style="margin-top:12px">
        <div class="tog" id="inf-tog" onclick="toggleInfinite()">
          <div class="tog-pill"></div>
          <div class="tog-lbl">무한 모드 (덱 자동 순환)</div>
        </div>
      </div>
    </div>
  </div>
  <button class="start-btn" onclick="startGame()">START</button>
</div>

<div id="game" class="screen">
  <div class="center-area" id="center-area">
    <div class="deck-card" id="deck0" onclick="drawCard(0)">
      <div class="deck-num" id="d0n">—</div>
      <div class="deck-lbl">덱 A</div>
    </div>
    <div id="wild-slot"></div>
    <div class="deck-card" id="deck1" onclick="drawCard(1)">
      <div class="deck-num" id="d1n">—</div>
      <div class="deck-lbl">덱 B</div>
    </div>
  </div>
  <div class="turn-label" id="turn-label"></div>
  <div id="player-areas"></div>
  <button id="end-game-btn" onclick="showEnd()" style="display:none;position:absolute;bottom:12px;left:50%;transform:translateX(-50%);padding:8px 22px;border-radius:20px;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.35);color:rgba(255,255,255,.5);font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;cursor:pointer;z-index:20;">게임 종료</button>
</div>

<div id="end" class="screen">
  <div class="end-title">GAME OVER</div>
  <div class="end-sub">덱 소진 — 최종 결과</div>
  <div class="lb" id="lb"></div>
  <div class="end-btns">
    <button class="end-btn" onclick="location.reload()">처음으로</button>
    <button class="end-btn primary" onclick="newGame()">재시작</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
var SYMBOLS=[
  {char:'●',color:'#d63031'},
  {char:'◆',color:'#2980b9'},
  {char:'★',color:'#e67e22'},
  {char:'■',color:'#8e44ad'}
];
var TOPICS=['사실 판단','가치 판단','도덕 판단'];
var WILD_COMBOS=[];
for(var _i=0;_i<4;_i++) for(var _j=_i+1;_j<4;_j++) WILD_COMBOS.push([_i,_j]);
var POSITIONS={
  2:['left','right'],
  3:['bottom-left','bottom-right','top-left'],
  4:['bottom-left','bottom-right','top-left','top-right']
};
var G={},numPlayers=2,totalCards=54,animating=false,infiniteMode=false;

function toggleInfinite(){
  infiniteMode=!infiniteMode;
  var tog=document.getElementById('inf-tog');
  tog.classList.toggle('on',infiniteMode);
  // disable/enable +/- buttons
  document.getElementById('cc-dec').disabled=infiniteMode;
  document.getElementById('cc-inc').disabled=infiniteMode;
  document.getElementById('cc-dec').style.opacity=infiniteMode?'0.3':'1';
  document.getElementById('cc-inc').style.opacity=infiniteMode?'0.3':'1';
}

/* ════════════════════════════════════════
   ADAPTIVE SIZING
   Goal: player card takes up as much space
   as possible while fitting all areas.
   Card ratio is always 1 : 1.4 (w:h).
   Score pile = card_w * 0.72 wide, card_h tall.
   Row = score_w + gap(12) + card_w
       = card_w*(0.72+1) + 12 = card_w*1.72+12
   Name tag height = name_font * 1.5 ≈ card_w*0.22
   Area total height = card_h + name_h + gap(10)
                     = card_w*1.4 + card_w*0.22 + 10
                     = card_w*1.62 + 10
   ════════════════════════════════════════ */
function computeSizes(){
  var W=window.innerWidth, H=window.innerHeight;
  var n=G.players?G.players.length:numPlayers;

  // Center cluster width: 3 deck-sized cards + 2 gaps
  // deck_w = card_w * 0.72, gap = 14
  // center_w = 3 * card_w*0.72 + 2*14 = card_w*2.16 + 28
  // center_h = card_w * 0.72 * 1.4 = card_w * 1.008

  var cardW;

  var PAD = 6; // minimal edge padding

  // All layouts now use corner-based positioning (2p=2 corners, 3p=3 corners, 4p=4 corners)
  // Corner area width  = (W - center_w) / 2  →  row_w = cardW*1.72+12 must fit
  // Corner area height = (H - center_h) / 2  →  area_h = cardW*1.59+10+PAD must fit
  // center_w ≈ cardW*2.16 + 28  (3 deck-width cards + 2 gaps of 14)
  // center_h ≈ cardW*1.008       (deck height)
  //
  // Horizontal: cardW*1.72+12 ≤ (W - cardW*2.16 - 28)/2 - PAD
  //   2*(cardW*1.72+12) + 2*PAD ≤ W - cardW*2.16 - 28
  //   cardW*(3.44+2.16) ≤ W - 28 - 24 - 2*PAD
  //   cardW*5.6 ≤ W - 52 - 2*PAD
  var byW = (W - 52 - PAD*2) / 5.6;
  // Vertical: cardW*1.59+10+PAD ≤ (H - cardW*1.008)/2 - PAD
  //   2*(cardW*1.59+10+PAD) + 2*PAD ≤ H - cardW*1.008
  //   cardW*(3.18+1.008) ≤ H - 20 - PAD*4
  //   cardW*4.188 ≤ H - 20 - PAD*4
  var byH = (H - 20 - PAD*4) / 4.188;
  var cardW = Math.min(byW, byH);

  cardW = Math.max(90, Math.min(320, Math.floor(cardW)));
  var cardH = Math.floor(cardW*1.4);
  var deckW = Math.floor(cardW*0.72);
  var deckH = Math.floor(deckW*1.4);
  var nameSize = Math.max(13, Math.floor(cardW*0.13));

  var r=document.documentElement;
  r.style.setProperty('--cw',cardW+'px');
  r.style.setProperty('--ch',cardH+'px');
  r.style.setProperty('--dw',deckW+'px');
  r.style.setProperty('--dh',deckH+'px');
  r.style.setProperty('--ns',nameSize+'px');
  return {cw:cardW,ch:cardH,dw:deckW,dh:deckH};
}

/* ── SETUP UI ── */
document.getElementById('count-row').addEventListener('click',function(e){
  var btn=e.target.closest('[data-n]');if(!btn)return;
  numPlayers=+btn.dataset.n;
  document.querySelectorAll('.count-btn').forEach(function(b){b.classList.remove('active');});
  btn.classList.add('active');buildNameInputs(numPlayers);
});
document.getElementById('cc-dec').onclick=function(){
  if(totalCards>20){totalCards-=6;document.getElementById('cc-val').textContent=totalCards;}
};
document.getElementById('cc-inc').onclick=function(){
  if(totalCards<120){totalCards+=6;document.getElementById('cc-val').textContent=totalCards;}
};
function buildNameInputs(n){
  var c=document.getElementById('name-inputs');c.innerHTML='';
  for(var i=0;i<n;i++){
    var inp=document.createElement('input');
    inp.className='name-input';inp.placeholder='플레이어 '+(i+1);
    inp.value='플레이어 '+(i+1);inp.id='pn'+i;c.appendChild(inp);
  }
}
buildNameInputs(2);
function startGame(){
  numPlayers=+document.querySelector('.count-btn.active').dataset.n;
  var names=[];
  for(var i=0;i<numPlayers;i++){
    var el=document.getElementById('pn'+i);
    names.push(el?(el.value.trim()||'플레이어 '+(i+1)):'플레이어 '+(i+1));
  }
  initGame(names);
}
function newGame(){initGame(G.players.map(function(p){return p.name;}));}

/* ── GAME INIT ── */
function shuffle(a){
  for(var i=a.length-1;i>0;i--){var j=0|Math.random()*(i+1);var t=a[i];a[i]=a[j];a[j]=t;}
  return a;
}
function makeDeck(limit){
  // Build topic and wild pools separately
  var topics=[];
  for(var s=0;s<4;s++) for(var t=0;t<3;t++) topics.push({type:'topic',symbol:s,topic:TOPICS[t]});
  var wilds=[];
  for(var c=0;c<WILD_COMBOS.length;c++) wilds.push({type:'wild',symbols:WILD_COMBOS[c]});

  // Expand topic pool to fill limit
  var topicPool=[];
  while(topicPool.length<limit){
    var sh=shuffle(topics.slice());
    for(var k=0;k<sh.length&&topicPool.length<limit;k++) topicPool.push(sh[k]);
  }
  topicPool=topicPool.slice(0,limit);

  // Sprinkle wilds: one wild per every ~8 topic cards, min gap of 6
  var wildPool=shuffle(wilds.slice());
  var result=topicPool.slice();
  var wildCount=Math.floor(limit/8);
  var placed=0;
  var lastWildPos=-7;
  // Collect candidate positions (not too close to each other or ends)
  var positions=[];
  for(var p=4;p<result.length-4;p++) positions.push(p);
  shuffle(positions);
  for(var pi2=0;pi2<positions.length&&placed<wildCount;pi2++){
    var pos=positions[pi2];
    if(pos-lastWildPos>=7){
      result.splice(pos,0,wildPool[placed%wildPool.length]);
      lastWildPos=pos;
      placed++;
    }
  }
  // Trim to limit and shuffle just slightly (keep rough spacing)
  result=result.slice(0,limit);
  return result;
}
function initGame(names){
  var full=makeDeck(totalCards),half=Math.ceil(full.length/2);
  G={
    players:names.map(function(n){return {name:n,playPile:[],scorePile:[]};}),
    decks:[shuffle(full.slice(0,half)),shuffle(full.slice(half))],
    activeWild:null,currentTurn:0
  };
  animating=false;
  computeSizes();
  buildPlayerAreas();
  showScreen('game');
  document.getElementById('end-game-btn').style.display=infiniteMode?'block':'none';
  renderGame();
}
function buildPlayerAreas(){
  var c=document.getElementById('player-areas');c.innerHTML='';
  var pos=POSITIONS[G.players.length];
  G.players.forEach(function(p,i){
    var area=document.createElement('div');
    area.className='player-area';area.setAttribute('data-pos',pos[i]);
    area.innerHTML=
      '<div class="player-row">'
      +'<div class="score-pile-wrap" id="spw'+i+'">'
      +'<div class="score-pile-btn" id="sp'+i+'" onclick="claimWin('+i+')">'
      +'<div class="score-num" id="sn'+i+'">0</div>'
      +'<div class="score-lbl">점수</div>'
      +'</div></div>'
      +'<div class="play-pile-wrap" id="ppw'+i+'">'
      +'<div class="play-pile-card empty" id="pp'+i+'">'
      +'<span style="color:rgba(255,255,255,.15);font-size:30px;">—</span>'
      +'</div></div>'
      +'</div>'
      +'<div class="player-name" id="nt'+i+'">'+p.name+'</div>';
    c.appendChild(area);
  });
}

/* ── DRAW ── */
function drawCard(di){
  if(animating)return;
  // In infinite mode, reshuffle this deck if empty
  if(G.decks[di].length===0){
    if(infiniteMode){
      G.decks[di]=makeDeck(Math.ceil(totalCards/2));
    } else {
      if(G.decks[1-di].length===0){showEnd();return;}
      showToast('그 덱은 비었어요!');return;
    }
  }
  var card=G.decks[di].shift();
  var pi=G.currentTurn;
  if(card.type==='wild'){
    // Wild: turn stays with current player — they must draw again
    flyCard(
      document.getElementById('deck'+di),
      document.getElementById('wild-slot'),
      card,function(){
        G.activeWild=card;
        // Do NOT advance turn — player draws again
        renderGame();checkEnd();
      }
    );
    return;
  }
  // Normal card: add to play pile then advance turn
  flyCard(
    document.getElementById('deck'+di),
    document.getElementById('ppw'+pi),
    card,function(){
      G.players[pi].playPile.push(card);
      G.currentTurn=(G.currentTurn+1)%G.players.length;
      renderGame();checkEnd();
    }
  );
}
function checkEnd(){
  if(infiniteMode) return; // never auto-end in infinite mode
  if(G.decks[0].length>0 || G.decks[1].length>0) return;
  var mm = matchMap();
  if(Object.keys(mm).length > 0) return;
  setTimeout(showEnd, 600);
}

/* ── FLY CARD ── */
function flyCard(fromEl,toEl,card,onDone){
  animating=true;
  var sz=computeSizes();
  var fr=fromEl.getBoundingClientRect();
  var tr=toEl.getBoundingClientRect();
  var isWild=card.type==='wild';
  var fw=isWild?sz.dw:sz.cw;
  var fh=isWild?sz.dh:sz.ch;
  var topicFs=Math.floor(fw*0.165);
  var symFs=Math.floor(fw*0.62);

  var fc=document.createElement('div');
  fc.className='flying-card';
  fc.style.width=fw+'px';fc.style.height=fh+'px';

  if(isWild){
    var s0=SYMBOLS[card.symbols[0]],s1=SYMBOLS[card.symbols[1]];
    fc.style.justifyContent='center';fc.style.gap='8px';
    fc.innerHTML=
      '<div style="display:flex;gap:8px;font-size:'+Math.floor(fw*0.38)+'px">'
      +'<span style="color:'+s0.color+'">'+s0.char+'</span>'
      +'<span style="color:'+s1.color+'">'+s1.char+'</span>'
      +'</div>'
      +'<div style="font-size:'+Math.floor(fw*0.12)+'px;letter-spacing:2px;color:#8b7a60;text-transform:uppercase;">WILD</div>';
  } else {
    var sym=SYMBOLS[card.symbol];
    fc.innerHTML=
      '<div style="width:100%;text-align:center;font-weight:900;font-size:'+topicFs+'px;color:rgba(255,255,255,.85);line-height:1.2;transform:rotate(180deg);">'+card.topic+'</div>'
      +'<div style="font-size:'+symFs+'px;line-height:1;color:'+sym.color+'">'+sym.char+'</div>'
      +'<div style="width:100%;text-align:center;font-weight:900;font-size:'+topicFs+'px;color:rgba(255,255,255,.85);line-height:1.2;">'+card.topic+'</div>';
  }

  var sx=fr.left+fr.width/2-fw/2;
  var sy=fr.top+fr.height/2-fh/2;
  fc.style.left=sx+'px';fc.style.top=sy+'px';
  document.body.appendChild(fc);

  var ex=tr.left+tr.width/2-fw/2;
  var ey=tr.top+tr.height/2-fh/2;

  requestAnimationFrame(function(){requestAnimationFrame(function(){
    fc.classList.add('fly');
    fc.style.transform='translate('+(ex-sx)+'px,'+(ey-sy)+'px)';
  });});
  setTimeout(function(){
    if(fc.parentNode)fc.parentNode.removeChild(fc);
    animating=false;onDone();
  },420);
}

/* ── MATCHING ── */
function symMatch(a,b){
  if(a===b)return true;
  if(G.activeWild){var x=G.activeWild.symbols[0],y=G.activeWild.symbols[1];
    if((a===x&&b===y)||(a===y&&b===x))return true;}
  return false;
}
function matchMap(){
  var m={};
  for(var i=0;i<G.players.length;i++) for(var j=i+1;j<G.players.length;j++){
    var ti=G.players[i].playPile[G.players[i].playPile.length-1];
    var tj=G.players[j].playPile[G.players[j].playPile.length-1];
    if(ti&&tj&&symMatch(ti.symbol,tj.symbol)){if(!(i in m))m[i]=j;if(!(j in m))m[j]=i;}
  }
  return m;
}

/* ── CLAIM WIN ── */
function claimWin(wi){
  if(animating)return;
  var m=matchMap();if(!(wi in m))return;
  var li=m[wi];
  var loser=G.players[li];if(loser.playPile.length===0)return;
  var card=loser.playPile[loser.playPile.length-1];
  flyCard(
    document.getElementById('ppw'+li),
    document.getElementById('spw'+wi),
    card,function(){
      G.players[li].playPile.pop();
      G.players[wi].scorePile.push(card);
      renderGame();
      checkEnd();
    }
  );
}

/* ── RENDER ── */
function renderGame(){
  var d0=G.decks[0].length, d1=G.decks[1].length;
  document.getElementById('d0n').textContent=infiniteMode?'∞':d0;
  document.getElementById('d1n').textContent=infiniteMode?'∞':d1;
  document.getElementById('deck0').classList.toggle('empty',!infiniteMode&&d0===0);
  document.getElementById('deck1').classList.toggle('empty',!infiniteMode&&d1===0);

  // wild slot
  var ws=document.getElementById('wild-slot');
  if(G.activeWild){
    var s0=SYMBOLS[G.activeWild.symbols[0]],s1=SYMBOLS[G.activeWild.symbols[1]];
    ws.className='';
    ws.innerHTML='<div class="wild-card">'
      +'<div class="wild-syms"><span style="color:'+s0.color+'">'+s0.char+'</span>'
      +'<span style="color:'+s1.color+'">'+s1.char+'</span></div>'
      +'<div class="wild-lbl">WILD</div></div>';
  } else {
    ws.className='wild-empty';ws.innerHTML='W';
  }

  document.getElementById('turn-label').textContent=G.players[G.currentTurn].name+' TURN';

  var mm=matchMap();
  var maxPlay=Math.max(1,G.players.reduce(function(mx,p){return Math.max(mx,p.playPile.length);},0));
  var maxScore=Math.max(1,G.players.reduce(function(mx,p){return Math.max(mx,p.scorePile.length);},0));

  G.players.forEach(function(p,i){
    var top=p.playPile[p.playPile.length-1];
    var ppw=document.getElementById('ppw'+i);
    var pile=document.getElementById('pp'+i);
    var spw=document.getElementById('spw'+i);
    var isMatch=i in mm, isCur=i===G.currentTurn;

    /* ── play pile stack shadows ── */
    ppw.querySelectorAll('.stack-shadow').forEach(function(s){s.remove();});
    // Visible layers: up to 8, each offset by 4px (so 8 cards = 32px total depth)
    var layers=Math.min(p.playPile.length,8);
    for(var s=layers;s>=1;s--){
      var sh=document.createElement('div');
      sh.className='stack-shadow';
      var o=s*4; // 4px per card layer — much more visible
      // Each layer peeks out from behind the top card
      sh.style.cssText='top:'+o+'px;left:'+o+'px;right:'+(-o)+'px;bottom:'+(-o)+'px;'
        +'opacity:'+(0.9-s*0.08)+';z-index:'+(10-s)+';';
      ppw.insertBefore(sh,pile);
    }

    /* ── play pile card face ── */
    var cw=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cw'))||140;
    if(top){
      var sym=SYMBOLS[top.symbol];
      pile.className='play-pile-card'+(isMatch?' match':'');
      pile.innerHTML=
        '<div class="topic-far" style="font-size:'+Math.floor(cw*0.165)+'px;color:rgba(255,255,255,.85)">'+top.topic+'</div>'
        +'<div class="sym-center" style="font-size:'+Math.floor(cw*0.62)+'px;color:'+sym.color+'">'+sym.char+'</div>'
        +'<div class="topic-near" style="font-size:'+Math.floor(cw*0.165)+'px;color:rgba(255,255,255,.85)">'+top.topic+'</div>';
    } else {
      pile.className='play-pile-card empty';
      pile.innerHTML='<span style="color:rgba(255,255,255,.15);font-size:30px;">—</span>';
    }

    /* ── score pile stack shadows ── */
    spw.querySelectorAll('.score-shadow').forEach(function(s){s.remove();});
    var sLayers=Math.min(p.scorePile.length,8);
    var sp=document.getElementById('sp'+i);
    for(var ss=sLayers;ss>=1;ss--){
      var ssh=document.createElement('div');
      ssh.className='score-shadow';
      var so=ss*4;
      ssh.style.cssText='top:'+so+'px;left:'+so+'px;right:'+(-so)+'px;bottom:'+(-so)+'px;'
        +'opacity:'+(0.9-ss*0.08)+';z-index:'+(10-ss)+';';
      spw.insertBefore(ssh,sp);
    }

    sp.className='score-pile-btn'+(isMatch?' claimable':'');
    document.getElementById('sn'+i).textContent=p.scorePile.length;

    var nt=document.getElementById('nt'+i);
    nt.textContent=p.name;nt.className='player-name'+(isCur?' cur':'');
  });
}

/* ── END ── */
function showEnd(){
  var sorted=G.players.map(function(p){return {name:p.name,score:p.scorePile.length};})
    .sort(function(a,b){return b.score-a.score;});
  var lb=document.getElementById('lb');lb.innerHTML='';
  for(var r=0;r<sorted.length;r++){
    var p=sorted[r],f=r===0;
    lb.innerHTML+='<div class="lb-row'+(f?' first':'')+'"><div class="lb-rank'+(f?' gold':'')+'">'+(r+1)+'</div>'
      +'<div class="lb-name">'+p.name+'</div><div class="lb-score">'+p.score+'장</div></div>';
  }
  showScreen('end');
}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}
function showToast(msg){
  var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  clearTimeout(t._t);t._t=setTimeout(function(){t.classList.remove('show');},2000);
}
window.addEventListener('resize',function(){if(G.players){computeSizes();renderGame();}});
</script>
</body>
</html>
